<!DOCTYPE html>
<html>
<head>
  <title>MQTT Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- MQTT JavaScript Library -->
  <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      text-align: center;
    }
    h1 {
      margin-top: 20px;
    }
    .card {
      background: white;
      padding: 20px;
      margin: 15px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    button {
      padding: 12px 25px;
      font-size: 16px;
      margin: 8px;
      cursor: pointer;
    }
    input[type=range] {
      width: 80%;
    }
    .value {
      font-size: 18px;
      margin-top: 10px;
    }
  </style>
</head>

<body>

<h1>My MQTT Dashboard</h1>

<!-- Light 1 -->
<div class="card">
  <h2>Light 1</h2>
  <button onclick="publishMessage('home/light1','ON')">ON</button>
  <button onclick="publishMessage('home/light1','OFF')">OFF</button>
</div>

<!-- Light 2 -->
<div class="card">
  <h2>Light 2</h2>
  <button onclick="publishMessage('home/light2','ON')">ON</button>
  <button onclick="publishMessage('home/light2','OFF')">OFF</button>
</div>

<!-- Fan Control -->
<div class="card">
  <h2>Fan</h2>
  <button onclick="publishMessage('home/fan','ON')">ON</button>
  <button onclick="publishMessage('home/fan','OFF')">OFF</button>

  <h3>Fan Speed / Voltage</h3>
  <input type="range" min="0" max="100" value="50" id="fanSlider" 
         oninput="updateFanSpeed(this.value)">
  <div class="value">
    Speed: <span id="speedValue">50</span> %
  </div>
</div>

<script>
  // ======= MQTT Broker Settings =======
  const broker = "ac06394e5b7343cdb4c4eba9ce00f71a.s1.eu.hivemq.cloud";
  const port = 8884;                   // WebSocket port
  const username = "masum_user";
  const password = "Mmasum.Bbillah1122";
  const clientId = "web_" + Math.floor(Math.random() * 1000);

  // ======= Create MQTT Client =======
  const client = new Paho.MQTT.Client(broker, port, "/mqtt", clientId);

  // ======= Connect Options =======
  const options = {
    useSSL: true,
    userName: username,
    password: password,
    onSuccess: onConnect,
    onFailure: onFailure
  };

  // ======= Connect to Broker =======
  client.connect(options);

  // ======= Connection Success Callback =======
  function onConnect() {
    console.log("Connected to MQTT broker!");
    // Subscribe to status topics for real-time updates
    client.subscribe("home/light1/status");
    client.subscribe("home/light2/status");
    client.subscribe("home/fan/status");
    client.subscribe("home/fan/speed");
  }

  // ======= Connection Failure Callback =======
  function onFailure(responseObject) {
    console.log("Connection failed: " + responseObject.errorMessage);
  }

  // ======= Handle Incoming Messages =======
  client.onMessageArrived = function(message) {
    const topic = message.destinationName;
    const payload = message.payloadString;
    console.log("Message arrived: " + topic + " = " + payload);

    // Update Light 1 button color
    if(topic === "home/light1/status") {
      document.querySelector('#light1Btn')?.setAttribute('style', 
        `background:${payload==='ON'?'#ff4444':'#44ff88'}`);
    }

    // Update Light 2 button color
    if(topic === "home/light2/status") {
      document.querySelector('#light2Btn')?.setAttribute('style', 
        `background:${payload==='ON'?'#ff4444':'#44ff88'}`);
    }

    // Update Fan button color and text
    if(topic === "home/fan/status") {
      document.querySelector('#fanBtn')?.setAttribute('style', 
        `background:${payload==='ON'?'#ff4444':'#44ff88'}`);
      document.querySelector('#fanBtn')?.innerText = payload==='ON'?'Fan OFF':'Fan ON';
    }

    // Update fan slider
    if(topic === "home/fan/speed") {
      document.getElementById("fanSlider").value = payload;
      document.getElementById("speedValue").innerText = payload;
    }
  };

  // ======= Publish Function =======
  function publishMessage(topic, payload) {
    if(client.isConnected()) {
      const message = new Paho.MQTT.Message(payload);
      message.destinationName = topic;
      client.send(message);
      console.log("Published: " + topic + " = " + payload);
    } else {
      console.log("MQTT not connected");
    }
  }

  // ======= Fan Slider =======
  function updateFanSpeed(value) {
    document.getElementById("speedValue").innerText = value;
    publishMessage("home/fan/speed", value); // Publish fan speed
  }
</script>

</body>
</html>

